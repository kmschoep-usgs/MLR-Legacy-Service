<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 

<mapper namespace="loggedAction">

    <resultMap id="result" type="LoggedAction">
        <result property="agencyCode" column="agency_cd" />
        <result property="siteNumber" column="site_no" />
        <result property="logChangeTimestamp" column="change_timestamp" />
        <result property="action" column="action" />
        <result property="changedField" column="changed_field" />
        <result property="oldValue" column="old_value" />
        <result property="newValue" column="new_value" />
    </resultMap>

    <sql id="dataCols">
        agency_cd, site_number, date_trunc('second',change_timestamp) change_timestamp, action, changed_field, old_value, new_value
    </sql>

	<sql id="baseQuery">
		select row_data -> 'agency_cd' as agency_code, 
		row_data -> 'site_no' as site_number, 
		action_tstamp_stm change_timestamp,
		action,
		skeys(changed_fields)  as changed_field,
		row_data -> skeys(changed_fields) as old_value, 
		svals(changed_fields) as new_value
		from <include refid="schemaName"/>logged_actions
		where action = 'U'
		union
		select row_data -> 'agency_cd' as agency_code, 
		row_data -> 'site_no' as site_number, 
		action_tstamp_stm change_timestamp,
		action,
		null  as changed_field,
		null as old_value, 
		null as new_value
		from <include refid="schemaName"/>logged_actions
		where action = 'I'
	</sql>
    
    <sql id="schemaName">
    	audit.
    </sql>

    <select id="find" resultMap="result">
		select <include refid="dataCols"/>
		from (<include refid="baseQuery"/>) base
		<where>
			<include refid="filters"/>
		</where>
	</select>

    
    <sql id="filters">
		<if test="agencyCode != null">
			and agency_code = #{agencyCode}
		</if>
		<if test="siteNumber != null">
			and site_number = #{siteNumber}
		</if>		
		<if test="startDate != null">
			 and date(change_timestamp) >= to_date(#{startDate}, 'YYYY-MM-DD') 
		</if>
		<if test="endDate != null">
			 and date(change_timestamp) &lt;= to_date(#{endDate}, 'YYYY-MM-DD') 
		</if>
		<include refid="base.commonFilters"/>
	</sql>
    

   

    
</mapper>